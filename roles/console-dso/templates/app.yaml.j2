apiVersion: argoproj.io/v1alpha1
kind: Application
metadata:
  annotations:
    kubectl.kubernetes.io/last-applied-configuration:
  name: console-pi-native
  namespace: {{ dsc.argocd.namespace }}
spec:
  destination:
    namespace: {{ dsc.console.namespace }}
    server: https://kubernetes.default.svc
  project: console-pi-native
  source: 
    path: helm
    repoURL: https://github.com/cloud-pi-native/console.git
    targetRevision: v{{ dsc.console.release }}
    releaseName: console-pi
    helm:
      parameters:
        - name: ingress.hosts[0]
          value: {{ console_domain }}
        - name: postgres.container.db
          value: dso-console-db
        - name: postgres.container.user
          value: dso
        - name: postgres.container.pass
          value: {{ dsc.console.dbPassword }}
        - name: keycloak.clientIdBackend
          value: {{ console_backend_secret.resources[0].data.CLIENT_ID | b64decode }}
        - name: keycloak.clientSecretBackend
          value: {{ console_backend_secret.resources[0].data.CLIENT_SECRET | b64decode }}
        - name: keycloak.clientIdFrontend
          value: {{ console_frontend_secret.resources[0].data.CLIENT_ID | b64decode }}
        - name: keycloak.redirectUri
          value: https://{{ console_domain }}
        - name: keycloak.sessionSecret
          value: {{ session_secret }}
        - name: keycloak.domain
          value: "{{ keycloak_domain }}"
        - name: keycloak.realm
          value: dso
{% if dsc.proxy.enabled %}
        - name: server.container.env.HTTP_PROXY
          value: {{ dsc.proxy.http_proxy }}
        - name: server.container.env.HTTPS_PROXY
          value: {{ dsc.proxy.https_proxy }}
        - name: server.container.env.NO_PROXY
          value: {{ dsc.proxy.no_proxy }}
{% endif %}
{% if dsc.exposedCA.type != 'none' %}
        - name: server.extraCa.name
          value: bundle
        - name: server.extraCa.key
          value: ca.pem
{% endif %}
{% for key, val in dsc.ingress.annotations.items() %}
        - name: ingress.annotations.{{ key | regex_escape }}
          value: {{ val }}
{% endfor %}
{% for key, val in dsc.ingress.labels.items() %}
        - name: ingress.labels.{{ key | regex_escape }}
          value: {{ val }}
{% endfor %}
{% if dsc.ingress.tls.type == 'tlsSecret' %}
        - name: ingress.tls.secretName
          value: {{ dsc.ingress.tls.tlsSecret.name }}
{% endif %}
{% if dsc.ingress.tls.type == 'none' %}
        - name: ingress.tls.enabled
          value: "false"
{% endif %}
  syncPolicy:
    automated: {}
    syncOptions:
    - CreateNamespace=true
